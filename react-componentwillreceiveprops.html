<!DOCTYPE html>
<html lang="zh">
<head>
        <meta charset="utf-8" />
        <title>React componentWillReceiveProps</title>
        <link rel="stylesheet" href="/theme/css/main.css" />
</head>

<body id="index" class="home">
        <header id="banner" class="body">
                <h1><a href="/">Hester's Blog </a></h1>
                <nav><ul>
                    <li class="active"><a href="/category/blog.html">blog</a></li>
                    <li><a href="/category/java-note.html">Java Note</a></li>
                    <li><a href="/category/note.html">Note</a></li>
                </ul></nav>
        </header><!-- /#banner -->
<section id="content" class="body">
  <article>
    <header>
      <h1 class="entry-title">
        <a href="/react-componentwillreceiveprops.html" rel="bookmark"
           title="Permalink to React componentWillReceiveProps">React componentWillReceiveProps</a></h1>
    </header>

    <div class="entry-content">
<footer class="post-info">
        <abbr class="published" title="2020-06-07T14:22:00+02:00">
                Published: 日 07 六月 2020
        </abbr>

        <address class="vcard author">
                By                         <a class="url fn" href="/author/hester.html">Hester</a>
        </address>
<p>In <a href="/category/blog.html">blog</a>.</p>

</footer><!-- /.post-info -->      <h2>问题背景</h2>
<p>学习React时教程中给出了下面一段代码</p>
<p>目的：兄弟组件之间通信
1. 子组件传递数据到父组件(父组件需要暴露一个函数给子组件)
2. 父组件通过设置prop的方式把数据传递给另一个自组件</p>
<div class="highlight"><pre><span></span><code>componentWillReceiveProps(nextProps, nextContext) {
    const {searchName} = nextProps
    if (searchName) {
        this.setState({init: false, loading: true})
        axios.get(`https://api.github.com/search/users?q=<span class="cp">${</span><span class="n">searchName</span><span class="cp">}</span>`)
            .then((reponse) =&gt; {
                let users = reponse.data.items.map((user, index) =&gt; {
                    return {
                        name: user.login,
                        url: user.html_url,
                        avatarUrl: user.avatar_url
                    }
                })
                this.setState({users, loading: false})
            })
            .catch((error) =&gt; {
                this.setState({error})
            })
    }
}
</code></pre></div>


<p><code>componentWillReceiveProps</code>是React组件自带的声明周期函数，当有新的props传递到组件会触发这个函数。同时上面的代码在该函数中调用了<strong>setState</strong></p>
<p>组件运行都正常，但是官方给出了warning</p>
<div class="highlight"><pre><span></span><code><span class="err">If you&#39;re updating state whenever props change, refactor your code to use memoization techniques or move it to static getDerivedStateFromProps. Learn more at: https://fb.me/react-derived-state</span>
</code></pre></div>


<p>使用这个方案的问题在于，如果父组件重新render，子组件的props无论是否改变都会调用<code>componentWillReceiveProps</code>，而我们希望的是只有props变化时才产生调用。</p>
<h2>解决方案</h2>
<h3>getDerivedStateFromProps</h3>
<p>替代方案的关键点<strong>getDerivedStateFromProps</strong></p>
<p>这个函数用于解决在props改变时更新state</p>
<div class="highlight"><pre><span></span><code><span class="err">// 静态函数，props表示新的props, state表示现有的state, 最终返回新的state</span>
<span class="err">static getDerivedStateFromProps(props, state) {</span>
<span class="err">// Any time the current user changes,</span>
<span class="err">// Reset any parts of state that are tied to that user.</span>
<span class="err">// In this simple example, that&#39;s just the email.</span>
<span class="err">if (props.userID !== state.prevPropsUserID) {</span>
<span class="err">    return {</span>
<span class="err">    prevPropsUserID: props.userID,</span>
<span class="err">    email: props.defaultEmail</span>
<span class="err">    };</span>
<span class="err">}</span>
<span class="err">return null;</span>
<span class="err">}</span>
</code></pre></div>


<p>但是原有的<code>componentWillReceiveProps</code>会进行两次setState，这种方案无法解决，除非把ajax调用放到父组件</p>
<h3>PubSubJS</h3>
<p><a href="https://github.com/mroderick/PubSubJS">PubSubJS</a>
发布订阅模式，用于跨层次传递数据</p>
<div class="highlight"><pre><span></span><code><span class="err">//发布端</span>
<span class="err">handleSearch = (event) =&gt; {</span>
<span class="err">    event.preventDefault()</span>
<span class="err">    const searchName = this.input.value</span>
<span class="err">    // 发布</span>
<span class="err">    PubSub.publish(&quot;search&quot;, searchName)</span>
<span class="err">    this.input.value = &quot;&quot;</span>
<span class="err">}</span>
</code></pre></div>


<div class="highlight"><pre><span></span><code>// 订阅端
componentDidMount() {
    //订阅
    PubSub.subscribe(&#39;search&#39;, (msg, searchName) =&gt; {
        if (searchName) {
            this.setState({init: false, loading: true})
            axios.get(`https://api.github.com/search/users?q=<span class="cp">${</span><span class="n">searchName</span><span class="cp">}</span>`)
                .then((reponse) =&gt; {
                    let users = reponse.data.items.map((user, index) =&gt; {
                        return {
                            name: user.login,
                            url: user.html_url,
                            avatarUrl: user.avatar_url
                        }
                    })
                    this.setState({users, loading: false})
                })
                .catch((error) =&gt; {
                    this.setState({error})
                })
        }
    })
}
</code></pre></div>
    </div><!-- /.entry-content -->

  </article>
</section>
        <section id="extras" class="body">
                <div class="blogroll">
                        <h2>links</h2>
                        <ul>
                            <li><a href="http://getpelican.com/">Pelican</a></li>
                            <li><a href="http://python.org/">Python.org</a></li>
                            <li><a href="http://jinja.pocoo.org/">Jinja2</a></li>
                            <li><a href="#">You can modify those links in your config file</a></li>
                        </ul>
                </div><!-- /.blogroll -->
                <div class="social">
                        <h2>social</h2>
                        <ul>

                            <li><a href="#">You can add links in your config file</a></li>
                            <li><a href="#">Another social link</a></li>
                        </ul>
                </div><!-- /.social -->
        </section><!-- /#extras -->

        <footer id="contentinfo" class="body">
                <address id="about" class="vcard body">
                Proudly powered by <a href="http://getpelican.com/">Pelican</a>, which takes great advantage of <a href="http://python.org">Python</a>.
                </address><!-- /#about -->

                <p>The theme is by <a href="http://coding.smashingmagazine.com/2009/08/04/designing-a-html-5-layout-from-scratch/">Smashing Magazine</a>, thanks!</p>
        </footer><!-- /#contentinfo -->

</body>
</html>